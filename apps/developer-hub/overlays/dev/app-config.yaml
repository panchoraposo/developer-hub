app:
  title: Red Hat Developer Hub on OpenShift

backend:
  baseUrl: https://backstage-developer-hub-backstage.${OPENSHIFT_CLUSTER_INGRESS_DOMAIN}
  listen:
    port: 7007
    host: 0.0.0.0

# --- AUTHENTICATION ---
## Development configuration
# auth:
#   providers:
#     guest:
#      dangerouslyAllowOutsideDevelopment: true

## Configuration required to enable OpenID Connect authentification
auth:
  session:
    secret: ${BACKEND_SECRET}
  environment: production
  providers:
    oidc:
      production:
        prompt: auto
        metadataUrl: https://keycloak.${OPENSHIFT_CLUSTER_INGRESS_DOMAIN}/realms/backstage/.well-known/openid-configuration
        clientId: ${OAUTH_CLIENT_ID}
        clientSecret: ${OAUTH_CLIENT_SECRET}
        signIn:
          resolvers:
            - resolver: preferredUsernameMatchingUserEntityName

signInPage: oidc

catalog:
  locations:
    - type: url
      target: https://github.com/backstage/backstage/blob/master/packages/catalog-model/examples/components/artist-lookup-component.yaml
  rules:
    - allow: [Component, System, API, Resource, Location, Template, Domain]
  
  providers:
  ## --- KEYCLOAK_CATALOG_PROVIDERS ---
    keycloakOrg:
      default:
        baseUrl: https://keycloak.${OPENSHIFT_CLUSTER_INGRESS_DOMAIN}
        loginRealm: backstage
        realm: backstage
        clientId: ${OAUTH_CLIENT_ID}
        clientSecret: ${OAUTH_CLIENT_SECRET}
        schedule:
          frequency: { minutes: 2 }
          timeout: { minutes: 1 }
          initialDelay: { seconds: 15}
  ## --- KEYCLOAK_CATALOG_PROVIDERS ---

## --- KEYCLOAK ---
extraEnvVars:
  - name: NODE_OPTIONS
    value: --no-node-snapshot
  - name: NODE_TLS_REJECT_UNAUTHORIZED
    value: "0"
## --- KEYCLOAK ---

## --- RBAC --- #
permission:
  enabled: true
  rbac:
    admin:
      users:
        - name: user:default/pe1
    #         - name: user:default/pe2
    policies-csv-file: ./rbac/rbac-policy.csv
    conditionalPoliciesFile: ./rbac/rbac-conditional-policies.yaml

extraVolumeMounts:
  - name: dynamic-plugins-root
    mountPath: /opt/app-root/src/dynamic-plugins-root
  - name: rbac-policy
    mountPath: /opt/app-root/src/rbac
    
extraVolumes:
  - name: dynamic-plugins-root
    persistentVolumeClaim:
      claimName: dynamic-plugins-root
  - name: dynamic-plugins
    configMap:
      defaultMode: 420
      name: developer-hub-dynamic-plugins
      optional: true
  - name: dynamic-plugins-npmrc
    secret:
      defaultMode: 420
      optional: true
      secretName: developer-hub-dynamic-plugins-npmrc
  - name: dynamic-plugins-registry-auth
    secret:
      defaultMode: 416
      optional: true
      secretName: developer-hub-dynamic-plugins-registry-auth
  - name: npmcacache
    emptyDir: {}
  - name: temp
    emptyDir: {}
  - name: rbac-policy
    configMap:
      name: rbac-policy
      defaultMode: 420
## --- RBAC --- #

scaffolder:
  enabled: true
  defaultAuthor:
    name: Red Hat Developer Hub
    email: rhdh@example.com
  templaters:
    cookiecutter:
      cookiecutterCommand: cookiecutter